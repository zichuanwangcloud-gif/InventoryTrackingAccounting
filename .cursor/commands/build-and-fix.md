
# 构建并修复错误命令

> **适用范围**：支持 Python、Java、Bash、C/C++、Go 等常见项目类型
> **核心目标**：自动运行构建、检测错误、自动修复错误，循环直到构建成功或达到最大迭代次数

------

## 0. 角色与原则

- 你扮演 **构建与错误修复专家**，负责自动化构建和错误修复流程
- 熟练使用：Python 构建工具、Java 构建工具（Maven/Gradle）、C/C++ 编译器、Go 构建工具、Bash 脚本检查工具、错误分析工具
- 原则：**自动检测项目类型 → 运行构建 → 分析错误 → 调用修复 agent → 验证修复 → 循环直到成功**

------

## 1. 工作流程

### Step 1 — 检测项目类型

自动识别项目类型和构建命令：

**Python 项目**：
- 检测标志：存在 `setup.py`、`pyproject.toml`、`requirements.txt`
- 构建命令：
  - `python -m py_compile <files>`（语法检查）
  - `mypy <package>`（类型检查，如果配置了 mypy）
  - `python setup.py build`（如果存在 setup.py）

**Java 项目**：
- 检测标志：存在 `pom.xml`（Maven）、`build.gradle` 或 `build.gradle.kts`（Gradle）、`*.java` 文件
- 构建命令：
  - `mvn compile` 或 `mvn clean compile`（Maven 项目）
  - `./gradlew build` 或 `gradle build`（Gradle 项目）
  - `javac -cp <classpath> *.java`（直接编译）

**Go 项目**：
- 检测标志：存在 `go.mod`、`*.go` 文件
- 构建命令：
  - `go build ./...`（构建所有包）
  - `go build`（构建当前包）
  - `go test -c`（编译测试）
  - `go vet ./...`（静态检查）

**C/C++ 项目**：
- 检测标志：存在 `Makefile`、`CMakeLists.txt`、`*.c`、`*.cpp`、`*.h` 文件
- 构建命令：
  - `make` 或 `make build`（使用 Makefile）
  - `cmake --build build`（使用 CMake）
  - `gcc -o <output> <files>` 或 `g++ -o <output> <files>`（直接编译）

**Bash 脚本项目**：
- 检测标志：存在 `*.sh` 文件
- 检查命令：
  - `shellcheck *.sh`（静态分析）
  - `bash -n *.sh`（语法检查）

**多项目仓库（Monorepo）**：
- 检测标志：存在多个子目录，每个都有独立的构建配置
- 处理方式：逐个检测并构建每个子项目

### Step 2 — 运行构建并捕获错误

```bash
# 示例：Python 项目
python -m py_compile src/**/*.py 2>&1 | tee /tmp/build-errors.log

# 示例：Java 项目（Maven）
mvn compile 2>&1 | tee /tmp/build-errors.log

# 示例：Go 项目
go build ./... 2>&1 | tee /tmp/build-errors.log

# 示例：C/C++ 项目（Makefile）
make 2>&1 | tee /tmp/build-errors.log

# 示例：Bash 脚本
shellcheck *.sh 2>&1 | tee /tmp/build-errors.log
```

**错误捕获要求**：
- 保存完整的错误输出到临时文件
- 记录构建命令的退出码
- 如果构建成功（退出码为 0），直接结束流程

### Step 3 — 分析错误

对捕获的错误进行分类：

**Python 错误类型**：
- `SyntaxError`: 语法错误
- `ImportError`: 导入错误
- `NameError`: 名称未定义
- `TypeError`: 类型错误

**Java 错误类型**：
- 编译错误：找不到符号、不兼容的类型
- 导入错误：包不存在、类找不到
- 语法错误：缺少分号、括号不匹配

**Go 错误类型**：
- 编译错误：未声明的变量、类型不匹配
- 导入错误：包找不到、循环导入
- 语法错误：缺少括号、语法结构错误

**C/C++ 错误类型**：
- 编译错误：未定义的引用、类型不匹配
- 链接错误：找不到函数定义、库链接失败
- 语法错误：缺少分号、宏定义错误

**Bash 错误类型**：
- 语法错误：缺少引号、括号不匹配
- 命令错误：命令不存在、路径错误
- 逻辑错误：变量未定义、条件判断错误

**通用错误模式**：
- 缺失依赖/导入
- 类型不匹配
- 语法错误
- 配置错误

### Step 4 — 错误修复

根据错误类型选择合适的修复策略：

**Python 错误修复**：
- 分析语法/导入问题，直接修复
- 检查依赖是否安装（pip install）
- 修复缩进和语法结构错误

**Java 错误修复**：
- 检查导入语句和包结构
- 修复类型不匹配和缺少的方法
- 检查 Maven/Gradle 依赖配置

**Go 错误修复**：
- 检查包导入路径
- 修复类型定义和接口实现
- 检查 go.mod 依赖

**C/C++ 错误修复**：
- 检查头文件包含和链接库
- 修复类型定义和函数声明
- 检查 Makefile 或 CMakeLists.txt 配置

**Bash 错误修复**：
- 修复语法错误（引号、括号等）
- 检查命令是否存在和路径正确性
- 修复变量引用和条件判断

**通用修复策略**：
- 配置错误：检查配置文件，修复配置问题
- 依赖错误：安装缺失的依赖
- 语法错误：根据语言特性修复语法问题

### Step 5 — 验证修复

修复后重新运行构建命令：

```bash
# 重新运行构建（根据项目类型选择相应命令）
# Python: python -m py_compile src/**/*.py
# Java: mvn compile 或 ./gradlew build
# Go: go build ./...
# C/C++: make
# Bash: shellcheck *.sh

# 检查退出码
if [ $? -eq 0 ]; then
    echo "✅ 构建成功！"
    exit 0
else
    echo "❌ 仍有错误，继续修复..."
fi
```

### Step 6 — 循环修复（最多 5 次迭代）

- **最大迭代次数**：5 次
- **每次迭代**：运行构建 → 分析错误 → 修复错误 → 验证
- **成功条件**：构建退出码为 0
- **失败条件**：达到最大迭代次数仍有错误

**迭代日志**：
```text
[迭代 1/5] 检测到 15 个错误，开始修复...
[迭代 2/5] 检测到 8 个错误，继续修复...
[迭代 3/5] 检测到 3 个错误，继续修复...
[迭代 4/5] 检测到 0 个错误，构建成功！✅
```

------

## 2. 执行流程（让 Cursor 严格按步骤推进）

### 自动化流程

1. **检测项目类型**
   - 扫描项目根目录，识别项目类型
   - 确定构建命令
   - 输出：项目类型、构建命令

2. **运行初始构建**
   - 执行构建命令
   - 捕获错误输出
   - 输出：构建结果、错误数量、错误摘要

3. **错误修复循环**（最多 5 次）
   - 如果构建成功，直接结束
   - 如果失败，分析错误类型
   - 调用相应的修复 agent 或直接修复
   - 重新运行构建验证
   - 记录每次迭代的结果

4. **生成修复报告**
   - 汇总修复的错误数量
   - 列出修复的文件
   - 记录最终构建状态

------

## 3. 错误修复策略

### Python 错误修复优先级

1. **导入错误**（最高优先级）
   - 缺失的 import
   - 错误的模块路径
   - 缺失的依赖包

2. **语法错误**
   - 缩进错误
   - 语法结构错误

3. **类型错误**
   - 类型注解错误（如果使用 mypy）

### Java 错误修复优先级

1. **导入和包错误**（最高优先级）
   - 缺失的 import 语句
   - 错误的包结构
   - 缺失的 Maven/Gradle 依赖

2. **类型和接口错误**
   - 类型不匹配
   - 接口实现不完整
   - 方法签名不匹配

3. **语法错误**
   - 缺少分号、括号等
   - 语法结构错误

### Go 错误修复优先级

1. **导入错误**（最高优先级）
   - 缺失的 import
   - 错误的包路径
   - 缺失的 go.mod 依赖

2. **类型错误**
   - 类型不匹配
   - 接口实现不完整
   - 类型断言错误

3. **语法错误**
   - 缺少括号、逗号等
   - 语法结构错误

### C/C++ 错误修复优先级

1. **头文件和链接错误**（最高优先级）
   - 缺失的头文件包含
   - 未定义的引用
   - 链接库配置错误

2. **类型和声明错误**
   - 类型不匹配
   - 函数声明不一致
   - 结构体定义错误

3. **语法错误**
   - 缺少分号、括号等
   - 预处理器错误

### Bash 错误修复优先级

1. **语法错误**（最高优先级）
   - 缺少引号、括号
   - 命令语法错误
   - 变量引用错误

2. **命令和路径错误**
   - 命令不存在
   - 文件路径错误
   - 权限问题

3. **逻辑错误**
   - 变量未定义
   - 条件判断错误
   - 函数调用错误

------

## 4. 使用方式

在 Cursor 中通过命令面板（Cmd+Shift+P）或直接引用此命令，AI 将帮助你：

1. **自动检测项目类型**：识别 Python、Java、Go、C/C++、Bash 等项目
2. **运行构建**：执行相应的构建命令
3. **自动修复错误**：根据错误类型自动修复或使用相关工具修复错误
4. **循环验证**：重复修复直到构建成功或达到最大迭代次数
5. **生成报告**：输出修复摘要和最终构建状态

## 5. 使用示例

### 示例 1：Python 项目构建修复

```bash
# 在 Cursor 中执行
/build-and-fix

# AI 将自动：
# 1. 检测到 Python 项目（存在 requirements.txt）
# 2. 运行 python -m py_compile 检查语法
# 3. 发现并修复语法错误
# 4. 重新验证直到构建成功
```

### 示例 2：Java Maven 项目构建修复

```bash
# 在 Cursor 中执行
/build-and-fix

# AI 将自动：
# 1. 检测到 Maven 项目（存在 pom.xml）
# 2. 运行 mvn compile
# 3. 分析编译错误
# 4. 修复导入错误、类型错误等
# 5. 循环修复直到成功
```

### 示例 3：Go 项目构建修复

```bash
# 在 Cursor 中执行
/build-and-fix

# AI 将自动：
# 1. 检测到 Go 项目（存在 go.mod）
# 2. 运行 go build ./...
# 3. 修复包导入、类型错误等
# 4. 验证修复结果
```

## 6. 示例输出

```text
🔍 检测项目类型...
✅ 检测到 Python 项目

🔨 运行构建...
❌ 构建失败，检测到 12 个错误

🔧 [迭代 1/5] 开始修复错误...
   - 修复导入错误：4 个
   - 修复语法错误：6 个
   - 修复类型错误：2 个

🔨 重新运行构建...
❌ 仍有 5 个错误

🔧 [迭代 2/5] 继续修复...
   - 修复导入错误：3 个
   - 修复配置错误：2 个

🔨 重新运行构建...
✅ 构建成功！

📊 修复摘要：
   - 总错误数：12
   - 修复文件数：6
   - 迭代次数：2
   - 最终状态：✅ 成功
```

## 6. 注意事项

- **最大迭代次数**：默认 5 次，避免无限循环
- **错误类型识别**：准确识别错误类型，选择合适的修复策略
- **构建命令检测**：优先使用项目配置的构建脚本
- **依赖安装**：如果检测到缺失依赖，自动安装
- **备份重要**：对于重大修复，建议先备份（可通过 git 状态检查）

## 7. 相关命令

- `git.status`: 查看 Git 状态（修复前建议检查）
- `code.refactor`: 执行代码结构优化
- `test.governance`: 执行测试治理任务

------

**最后更新**：2025-11-29
**维护者**：Clouditera Team
**版本**：**1.0.0（初始版本）**
