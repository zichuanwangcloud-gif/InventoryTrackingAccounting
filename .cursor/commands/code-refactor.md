
# 🧩  结构优化提示任务（含备份、单测校验与重点标注 · 分步落盘版）

## 🎯 目标
1. 你是一名拥有 20+ 年经验的代码架构师，请对给定文件进行 **结构优化**，并保证：
   1. **不改行为**：仅重排结构与补注释，函数签名/公共接口/导出符号保持不变。
   2. **先备份**：改动前先完整备份，保留回滚路径。
   3. **单测通过**：改动后单元测试需通过（仅最小必要补测，不改业务断言）。
   4. **策略：**一步=一文档，完成即落盘，尽量不在对话框回显长内容。
   5. **重点标注，不做修改**：
      - 过度封装/过度设计的函数：**仅注释提醒**下次审计关注点。
      - 过时的**新旧混用**位置：**仅注释标记**，不做替换与重构。
      - 可复用别人（或已有）代码处：**仅注释标记**"可复用、避免重复实现"。
      -  **函数重复实现**：在同仓/同模块内发现**重复或近重复函数**，仅**加注释标记**并列出"重复关系图"。


## 🛡 执行"护栏"
- 不重命名模块/类/函数/参数（除非文档明确要求，否则不允许）。
- 不新增/删除业务逻辑，不增删运行期副作用（日志级别、异常类型等）。
- 不改变导入时序与顶层执行副作用（import-time side effects）。
-  **允许**：  
   - 仅重排**定义顺序**；  
   - 补充/修正**文档注释**；  
   - 将未用/过期函数集中到 **LEGACY 区** 并标注；  
   - 添加**审计性注释**；  
   - **删除未使用导入**，需满足：① 非 `__all__` 暴露；② 无副作用；③ 非类型检查必需（`if TYPE_CHECKING:` 内保留）；④ 非注册/插件发现式导入。若存疑，保留并添加 `# [REVIEW:IMPORT-SIDE-EFFECT?]`。  


## 📦 改动前备份（必须执行）
在开始修改前，创建只读备份，并在 **01 文档**记录 `BACKUP_SNAPSHOT`：
```bash
# 变量（由调用方或脚本注入）
TARGET_FILE="<path/to/your_file.py>"
BASENAME="$(basename "$TARGET_FILE")"         # {basename}
STAMP="$(date +%Y%m%d-%H%M)"                  # {stamp}
BACKUP_DIR="<repo_root>/backup/${BASENAME}/${STAMP}"

mkdir -p "$BACKUP_DIR"
cp -a "$TARGET_FILE" "$BACKUP_DIR/"

# 输出证明（写入 01-备份记录-{basename}.md）
echo "BACKUP_SNAPSHOT=${BACKUP_DIR}/${BASENAME}"
```



## 📐 代码组织顺序规范（从上到下）
1. 模块文档 / 版权说明
2. 导入区（标准库 → 第三方 → 内部模块）
3. 模块常量 / 配置 / 异常定义
4. 核心公共类
   - `__init__`
   - 公共方法
   - 受保护方法 `_method`
   - 私有方法 `__method`
   - 工具/辅助方法
   - 魔术方法 `__repr__` / `__enter__` 等
5. 模块级函数（公共 → 受保护 → 私有）
6. 示例/调试入口（如必须保留）
7. **LEGACY 区**（未调用/过期函数，仅标注，不修改）

------

## ✍️ 函数注释完善

### 类级注释

- **职责**、**核心功能**、**使用场景**、**架构说明**（依赖/协作对象/线程与异常策略等）。

### 方法级注释（标准模板）

```python
def method_name(self, param1: str, param2: int) -> Dict[str, Any]:
    """
    方法功能的简洁描述

    详细的业务逻辑说明，包括：
    - 核心处理流程
    - 特殊情况处理
    - 与其他方法的关系

    Args:
        param1: 参数1的详细说明
        param2: 参数2的详细说明

    Returns:
        Dict[str, Any]: 返回值的详细说明
        {
            "key1": "值1的含义",
            "key2": "值2的含义"
        }

    Raises:
        SpecificException: 什么情况下抛出此异常

    Example:
        >>> result = obj.method_name("test", 123)
        >>> print(result["key1"])
    """
```

### 行内注释 & 待办标记

- **行内注释**：仅对**关键逻辑步骤、复杂算法、业务规则**进行简要说明，避免赘述代码本身。
- **TODO/FIXME 标记**：标注需要后续处理的问题或技术债务，附**原因与建议方向**（如 `# TODO: 解释原因 / 建议重构路径`）。



### 审计性标注（仅注释，不改逻辑）

**A. 过度封装/过度设计（Over-engineering）**

```
# [REVIEW:OVER-ENGINEERING] 现状：层次过深/抽象过度/参数爆炸/通用性与场景不匹配。
# 影响：可读性/可测试性下降，修改成本高。
# 建议（仅记录，不实施）：合并层级/内联一次性封装/通过组合替代多级继承。
```

**B. 新旧混用（Mixed legacy & modern）**

```
# [REVIEW:MIXED-LEGACY] 同一功能同时使用新旧API/风格（示例：requests v1 + httpx）。
# 影响：行为不一致/异常处理与日志语义不统一。
# 建议（仅记录，不实施）：统一到 <建议方案>，提供适配层过渡。
```

**C. 可复用他人/已有实现（Duplicate external/library reuse）**

```
# [REVIEW:DUPLICATE] 存在可复用实现：<module.path: func|class>；建议直接复用，避免重复实现。
```

**D. 函数重复实现（仓内/模块内重复）**

- **重复定义**（完全重复/结构等价）：

```
# [REVIEW:DUP-FUNC] 与 <file:path:Class.func@Lxx> 实现重复（结构哈希=abc123，长度=42行）。
# 建议（仅记录，不实施）：统一复用，被复用函数作为主实现。
```

- **近重复**（相似度阈值 ≥ 0.8）：

```
# [REVIEW:DUP-NEAR] 与 <file:path:func@Lyy> 高度相似（token 相似度=0.86，差异集中于参数校验）。
# 建议（仅记录，不实施）：抽取公共子过程或以参数化差异化实现。
```

> **检测建议（静态启发式，仅用于生成标注，不改动代码）**：
>
> - **结构哈希**：AST 规范化（去注释/空白、变量占位、常量归一）后取 `sha256`，哈希相同视作强重复。
> - **令牌相似度**：对标识符/关键字/字面量分词，Jaccard/余弦 ≥ **0.8** 视为近重复。
> - **最小长度**：函数体 ≥ **12 行** 或 ≥ **80 token** 才纳入比对，降低误报。

**E. 导入可疑副作用/未用导入**

```
# [REVIEW:IMPORT-UNUSED] 未被引用的导入，已安全删除（无副作用、非 __all__/TYPE_CHECKING/注册）。
# [REVIEW:IMPORT-SIDE-EFFECT?] 怀疑存在副作用导入，暂不删除，请复核。
```

------

### LEGACY 区处理方式（只移动与标注）

```
# =============================================================================
# LEGACY / UNUSED / DEPRECATED ZONE
# 以下函数未被调用或已标记过期，仅保留，不修改逻辑。
# =============================================================================

def old_helper(...):
    """[LEGACY] 未被调用，历史兼容保留。"""
    ...
```

> 判定依据：引用图无入边；注释含 deprecated/legacy/obsolete/TODO remove；命名含 old_/legacy_/_v1 等（结合上下文审慎判定）。



------

## 🧪 单元测试要求（必须通过）

重排与注释补全完成后，执行最小必要的测试验证：

```bash
# 推荐指令（按项目实际替换）
pytest -q --maxfail=1 --disable-warnings
# 如有覆盖率要求（可选）：
pytest -q --cov=<your_package> --cov-report=term-missing
```

- 仅在**结构变动引起用例失配**时，做**最小修正**（例如导入路径更新），不得更改业务断言。
- 若目标文件无覆盖关键路径，可**最小新增**烟囱式用例，验证对外行为不变。



## 🗂 分步落盘策略（一步=一文档，完成即写盘）

- **文档基础路径**：`docs/format/{basename}/{stamp}/`
  - 建议：`basename = <目标文件名>`，`stamp = YYYYMMDD-HHMM`

- **备份基础路径**：`<repo_root>/backup/{basename}/{stamp}/`  （与文档的 `{basename}/{stamp}` 同步）

**文档与文件名（每步执行完立即写盘）**

1. `01-备份记录.md`：目标文件、`BACKUP_SNAPSHOT`、回滚命令、（可选）校验和。
2. `02-结构重排.md`：重排目录预览（树形清单）、保持原位成员与原因（如 import-time 副作用）。
3. `03-注释补全.md`：需补全/改进的类/函数清单 + 一句话建议 + 模板片段。
4. `04-审计标注.md`：格式如下
   
   ```bash
   # 审计标注清单
   
   ## 0. 来源信息
   - 原始文件路径: {TARGET_FILE}
   
   ## 1. Over-engineering 列表
   | 位置 | 原因 | 影响 | 建议 |
   |------|------|------|------|
   
   ## 2. Mixed-legacy 列表
   | 位置 | 新旧点 | 影响 | 建议 |
   |------|--------|------|------|
   
   ## 3. Duplicate 列表
   | 重复位置 | 推荐复用目标 | 建议（迁移/抽取方向） |
   |----------|--------------|-----------------------|
   
   ## 4. Dead Code / Unused 列表
   | 位置 | 表现 | 影响 | 建议 |
   |------|------|------|------|
   
   ## 5. Inconsistent Style / Convention Drift 列表
   | 位置 | 表现 | 影响 | 建议 |
   |------|------|------|------|
   
   ## 6. Performance Pitfalls 列表
   | 位置 | 表现 | 影响 | 建议 |
   |------|------|------|------|
   
   ## 7. Security Smells 列表
   | 位置 | 表现 | 影响 | 建议 |
   |------|------|------|------|
   
   ## 8. Poor Abstraction Boundaries 列表
   | 位置 | 表现 | 影响 | 建议 |
   |------|------|------|------|
   
   ## 9. Test Debt 列表
   | 位置 | 表现 | 影响 | 建议 |
   |------|------|------|------|
   ```
5. `05-LEGACY清单.md`：名称 | 分类（unused/deprecated）| 证据摘要 | 处理方式（移动+标注）。
6. `06-单测报告.md`：运行指令、结果摘要（通过/失败与要点）、最小适配说明、**安全性声明**（签名/接口/副作用未变）。

> 要求：每完成一个步骤立即生成对应文档；**禁止**在对话框输出大段正文，最多回显目标路径与完成提示。

## ✅ 结束条件

- 01~06 六份文档已在 ：`docs/format/{basename}/{stamp}/`` 生成；
- 备份已在 `<repo_root>/backup/{basename}/{stamp}/` 生成并可回滚；
- 单测通过；
- 源文件的公共接口与行为未变化。

------

## 使用方式

在 Cursor 中通过命令面板（Cmd+Shift+P）或直接引用此命令，AI 将帮助你：

1. **执行结构优化**：按照上述规范对代码进行结构重组和注释完善
2. **生成备份**：在修改前自动创建完整备份
3. **生成文档**：分步生成 6 份详细文档记录优化过程
4. **验证测试**：确保优化后单元测试通过

## 注意事项

- **不改行为**：所有优化仅涉及结构重组和注释补充，不改变代码行为
- **先备份**：修改前必须创建完整备份
- **单测通过**：优化后必须确保单元测试通过
- **重点标注**：对发现的问题仅做标注，不进行修改
- **分步落盘**：每完成一步立即生成对应文档

## 相关命令

- `git.commit`: 提交结构优化变更
- `test.governance`: 执行测试治理任务
- `document.create`: 创建优化文档

------

**最后更新**：2025-11-29
 **维护者**：Architecture Team
 **版本**：**2.2.0（分步落盘版 · 含备份与单测校验）**
